<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seteeduca - Matrícula e Rematrícula</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #e8e8e8;
            min-height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #FFF4DF 0%, #f8f0e3 100%);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
            flex-shrink: 0;
        }

        .logo {
            padding: 0px 40px;
            text-align: center;
            margin-bottom: 25px;
            margin-top: 30px;
        }

        .logo img {
            max-width: 100%;
            height: auto;
        }

        .menu {
            flex: 1;
            padding: 20px 18px;
            overflow-y: auto;
        }

        .menu-item {
            padding: 30px 20px;
            margin-bottom: 6px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            font-weight: 500;
            overflow: visible;
            color: black;
        }

        .menu-item i {
            margin-right: 15px;
            font-size: 18px;
            width: 24px;
            text-align: center;
            z-index: 2;
        }

        .menu-item span {
            z-index: 2;
            font-size: 15px;
        }

        .menu-item:hover {
            background-color: #6c757d21;
        }

        .menu-item::after {
            padding: 0 10px;
            content: '';
            position: absolute;
            bottom: -3px;
            left: 20px;
            height: 2px;
            width: 0px;
            transition: width 0.3s ease;
            border-radius: 1px;
        }

        .menu-item:hover::after,
        .menu-item.active::after {
            width: calc(100% - 40px);
        }

    .menu-item:nth-child(1)::after { background-color: #F4BF27; }
    .menu-item:nth-child(2)::after { background-color: #00A6FF; }
    .menu-item:nth-child(3)::after { background-color: #9747FF; }
    .menu-item:nth-child(4)::after { background-color: #F88C12; }
    .menu-item:nth-child(5)::after { background-color: #D22A2A; }
    .menu-item:nth-child(6)::after { background-color: #59C631; }
    .menu-item.active {
            background-color: rgba(128, 128, 128, 0.356);
            color: #333;
            font-weight: 600;
        }

        .seteeduca {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }

        .sidebar-footer {
            padding: 20px 18px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .logout-button {
            padding: 16px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #333;
            width: 100%;
        }

        .logout-button i {
            margin-right: 15px;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .logout-button:hover {
            background-color: rgba(210, 42, 42, 0.1); 
            color: #D22A2A; 
            font-weight: 600;
        }

        .main-content {
            flex: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #9154e0;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            color: white;
            width: 100%;
        }

        .header-title {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: 600;
        }

        .header-title i {
            margin-right: 15px;
            font-size: 28px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }

        .profile-pic {
            width: 45px;
            height: 45px;
            background: #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .content-area {
            padding: 30px;
            background: #fcf8f2;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .form-section {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-top: 5px solid #9154e0;
            min-height: 600px;
        }

        .list-section {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-top: 5px solid #9154e0;
            max-height: 700px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #A96BFA;
            border-bottom-color: #9154e0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .field-row {
            display: flex;
            gap: 20px;
        }

        .field-row .field-group {
            flex: 1;
        }

        label {
            font-weight: 600;
            font-size: 1rem;
            color: #333;
            margin-left: 10px;
        }

        input, select {
            padding: 14px 18px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            background: white;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #9154e0;
            box-shadow: 0 0 0 3px rgba(151, 71, 255, 0.2);
        }

        .btn-primary {
            padding: 16px 30px;
            background: #9154e0;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(151, 71, 255, 0.3);
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: #9154e0;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(151, 71, 255, 0.4);
        }

        .btn-reload {
            background: #59C631;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: none; /* Oculto por padrão */
        }

        .student-info {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .student-info h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .student-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            color: #666;
            font-size: 0.95rem;
        }

        .matricula-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .matricula-card:hover {
            border-color: #9154e0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(151, 71, 255, 0.15);
        }

        .matricula-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .matricula-number {
            font-weight: 700;
            color: #9154e0;
            font-size: 1.1rem;
        }

        .matricula-actions {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #e3f2fd;
            color: #1976d2;
        }

        .btn-edit:hover {
            background: #bbdefb;
            transform: translateY(-1px);
        }

        .btn-delete {
            background: #ffebee;
            color: #d32f2f;
        }

        .btn-delete:hover {
            background: #ffcdd2;
            transform: translateY(-1px);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-ativa {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border-top: 5px solid #4CAF50;
            animation: modalFadeIn 0.4s ease;
        }

        .modal-content p {
            font-size: 1.2rem;
            margin: 20px 0;
            color: #333;
            font-weight: 500;
            white-space: pre-line;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-buttons button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-confirm {
            background: #9154e0;
            color: white;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .error-message {
            background: #fff3cd;
            border: 1px solid #ffecb5;
            color: #664d03;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .success-message {
            background: #d1edff;
            border: 1px solid #b6effb;
            color: #055160;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .turmas-info {
            display: none; /* Oculta o painel de informações */
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .field-row {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .menu-item span, .logout-button span {
                display: none;
            }
            
            .menu-item i, .logout-button i {
                margin-right: 0;
            }
            
            .student-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div>
            <div class="logo">
                <img src="imagem/logo.png" alt="logo">
            </div>
            <div class="menu">
                <div class="menu-item" onclick="navegarPara('inicio')">
                    <i class="fas fa-home"></i>
                    <span>INÍCIO</span>
                </div>
                <div class="menu-item" onclick="navegarPara('cadastro')">
                    <i class="fas fa-address-card"></i>
                    <span>CADASTRO</span>
                </div>
                <div class="menu-item active" >
                    <i class="fas fa-user-graduate"></i>
                    <span>MATRÍCULA</span>
                </div>
                <div class="menu-item" onclick="navegarPara('professor')">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>PROFESSOR</span>
                </div>
                <div class="menu-item" onclick="navegarPara('turmas')">
                    <i class="fas fa-users"></i>
                    <span>TURMA</span>
                </div>
                
                <div class="menu-item" onclick="navegarPara('financeiro')">
                    <i class="fas fa-dollar-sign"></i>
                    <span>FINANCEIRO</span>
                </div>
            </div>
        </div>

        <div>
            <div class="seteeduca">
                <p>@seteeduca</p>
            </div>
            <div class="sidebar-footer">
                <div class="logout-button" onclick="logout()">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span>Sair</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div class="header-title">
                <i class="fas fa-user-graduate"></i>
                Matrícula
            </div>
            <div class="user-profile">
                <div class="profile-pic">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div class="container">
                <!-- Form Section -->
                <div class="form-section">
                    <!-- Removido o painel de informações -->

                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('matricula')">
                            <i class="fas fa-plus-circle"></i> Nova Matrícula
                        </div>
                        <div class="tab" onclick="switchTab('rematricula')">
                            <i class="fas fa-edit"></i> Rematrícula
                        </div>
                    </div>

                    <!-- Nova Matrícula -->
                    <div class="tab-content active" id="matricula-content">
                        <form id="matriculaForm">
                            <div class="field-group">
                                <label for="cpfEstudante">CPF do Estudante:</label>
                                <input type="text" id="cpfEstudante" name="cpfEstudante" 
                                       placeholder="000.000.000-00" maxlength="14" required>
                            </div>

                            <div id="studentInfo" class="student-info" style="display: none;">
                                <h4 id="studentName"></h4>
                                <div class="student-details" id="studentDetails"></div>
                            </div>

                            <div class="field-row">
                                <div class="field-group">
                                    <label for="turma">Turma:</label>
                                    <select id="turma" name="turma" required>
                                        <option value="">Selecione a turma</option>
                                    </select>
                                </div>
                                <div class="field-group">
                                    <label for="dataMatricula">Data da Matrícula:</label>
                                    <input type="date" id="dataMatricula" name="dataMatricula" required>
                                </div>
                            </div>

                            <div class="field-group">
                                <label for="anoLetivo">Ano Letivo:</label>
                                <input type="text" id="anoLetivo" name="anoLetivo" readonly
                                       style="background-color: #f8f9fa; color: #6c757d;">
                            </div>

                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save"></i>
                                Realizar Matrícula
                            </button>
                        </form>
                    </div>

                    <!-- Rematrícula -->
                    <div class="tab-content" id="rematricula-content">
                        <form id="rematriculaForm" style="display: none;">
                            <div class="field-group">
                                <label for="estudanteRematricula">Estudante:</label>
                                <input type="text" id="estudanteRematricula" readonly>
                            </div>

                            <div class="field-row">
                                <div class="field-group">
                                    <label for="turmaAtual">Turma Atual:</label>
                                    <input type="text" id="turmaAtual" readonly>
                                </div>
                                <div class="field-group">
                                    <label for="novaTurma">Nova Turma:</label>
                                    <select id="novaTurma" name="novaTurma" required>
                                        <option value="">Selecione a nova turma</option>
                                    </select>
                                </div>
                            </div>

                            <div class="field-row">
                                <div class="field-group">
                                    <label for="numeroMatriculaRematricula">Número da Matrícula:</label>
                                    <input type="text" id="numeroMatriculaRematricula" readonly>
                                </div>
                                <div class="field-group">
                                    <label for="dataRematricula">Data da Rematrícula:</label>
                                    <input type="date" id="dataRematricula" name="dataRematricula" required>
                                </div>
                            </div>

                            <button type="submit" class="btn-primary">
                                <i class="fas fa-sync"></i>
                                Confirmar Rematrícula
                            </button>
                        </form>

                        <div id="selectMatriculaMessage">
                            <p style="text-align: center; color: #666; margin-top: 50px;">
                                <i class="fas fa-arrow-right" style="font-size: 2rem; margin-bottom: 20px;"></i><br>
                                Selecione uma matrícula na lista ao lado para editar
                            </p>
                        </div>
                    </div>
                </div>

                <!-- List Section -->
                <div class="list-section">
                    <div class="section-title">
                        <i class="fas fa-list"></i>
                        Matrículas Ativas
                        <span style="font-size: 0.8rem; color: #666; font-weight: normal;" id="matriculasCounter">(0)</span>
                    </div>
                    
                    <div id="matriculasList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button class="btn-confirm" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        let estudantes = [];
        let turmas = [];
        let matriculas = [];
        let matriculaEditando = null;

        // Dados de estudantes carregados do sistema
        const estudantesDisponiveis = [];

        // Função para carregar estudantes do sistema
        function carregarEstudantes() {
            // Tentar carregar estudantes cadastrados
            const estudantesStorage = sessionStorage.getItem('estudantes') || localStorage.getItem('estudantes');
            if (estudantesStorage) {
                try {
                    const estudantesParsed = JSON.parse(estudantesStorage);
                    estudantesDisponiveis.push(...estudantesParsed);
                } catch (e) {
                    console.warn('Erro ao carregar estudantes:', e);
                }
            }
        }

        function carregarDados() {
            console.log('Carregando dados...');
            
            // Carregar estudantes do sistema
            carregarEstudantes();
            
            // Carregar turmas usando a mesma estratégia do sistema de turmas
            let turmasEncontradas = [];
            
            // 1. Tentar sessionStorage primeiro (mais recente)
            const turmasSession = sessionStorage.getItem('turmas');
            if (turmasSession) {
                try {
                    turmasEncontradas = JSON.parse(turmasSession);
                    console.log('Turmas carregadas do sessionStorage:', turmasEncontradas.length);
                } catch (e) {
                    console.error('Erro ao parsear turmas do sessionStorage:', e);
                }
            }
            
            // 2. Se não encontrou no sessionStorage, tentar localStorage
            if (turmasEncontradas.length === 0) {
                const turmasLocal = localStorage.getItem('turmas');
                if (turmasLocal) {
                    try {
                        turmasEncontradas = JSON.parse(turmasLocal);
                        console.log('Turmas carregadas do localStorage:', turmasEncontradas.length);
                    } catch (e) {
                        console.error('Erro ao parsear turmas do localStorage:', e);
                    }
                }
            }
            
            // 3. Se ainda não encontrou, tentar window.turmas
            if (turmasEncontradas.length === 0 && typeof window.turmas !== 'undefined') {
                turmasEncontradas = window.turmas;
                console.log('Turmas carregadas do window.turmas:', turmasEncontradas.length);
            }
            
            turmas = turmasEncontradas;
            estudantes = estudantesDisponiveis;

            // Carregar matrículas (apenas em memória)
            const matriculasSession = sessionStorage.getItem('matriculas');
            const matriculasLocal = localStorage.getItem('matriculas');
            
            if (matriculasSession) {
                try {
                    matriculas = JSON.parse(matriculasSession);
                } catch (e) {
                    console.warn('Erro ao carregar matrículas do sessionStorage:', e);
                    matriculas = [];
                }
            } else if (matriculasLocal) {
                try {
                    matriculas = JSON.parse(matriculasLocal);
                } catch (e) {
                    console.warn('Erro ao carregar matrículas do localStorage:', e);
                    matriculas = [];
                }
            } else {
                matriculas = [];
            }
            
            console.log(`Dados carregados - Estudantes: ${estudantes.length}, Turmas: ${turmas.length}, Matrículas: ${matriculas.length}`);
            atualizarContadores();
        }

        function atualizarContadores() {
            // Função simplificada - apenas atualiza o contador de matrículas
            document.getElementById('matriculasCounter').textContent = `(${matriculas.length})`;
        }

        function recarregarTurmas() {
            // Aqui você pode implementar a lógica para recarregar as turmas, se necessário.
        }

        // Função para navegação entre páginas
        function navegarPara(pagina) {
            // Rotas baseadas no seu servidor Express
            const rotas = {
                'inicio': '/home',                    // Rota para home
                'professor': '/cadastro-professor',     // Adicione esta rota no seu servidor se necessário
                'financeiro': '/opcoes-financeiro',   // Rota existente para financeiro
                'turmas': '/turmas-cadastradas',      // Rota existente para turmas
                'matricula': '/matricula',            // Página atual
                'cadastro': '/opcoes-aluno'           // Rota existente para cadastro de aluno
            };

            // Navegar para a página correspondente
            if (rotas[pagina]) {
                window.location.href = rotas[pagina];
            } else {
                console.warn(`Rota não encontrada para: ${pagina}`);
                // Fallback - mostrar modal informativo
                showModal(`Página "${pagina.toUpperCase()}" em desenvolvimento.\nEm breve estará disponível!`);
            }
        }

        // Função para logout
        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                // Limpar dados da sessão se necessário
                sessionStorage.clear();
                localStorage.clear();
                // Redirecionar para página de login
                window.location.href = '/login';
            }
        }

        function formatarCPF(cpf) {
            // Remove tudo que não é dígito
            cpf = cpf.replace(/\D/g, '');
            
            // Aplica a formatação
            cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
            cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
            cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            
            return cpf;
        }

        function buscarEstudantePorCPF() {
            const cpf = document.getElementById('cpfEstudante').value.replace(/\D/g, '');
            
            if (cpf.length === 11) {
                const estudante = estudantes.find(e => e.cpf && e.cpf.replace(/\D/g, '') === cpf);
            
            if (!estudante) {
                if (estudantes.length === 0) {
                    showModal('Nenhum estudante cadastrado no sistema!\nCadastre estudantes primeiro antes de realizar matrículas.');
                } else {
                    showModal('Estudante não encontrado!\nVerifique se o CPF está correto ou se o estudante está cadastrado no sistema.');
                }
                document.getElementById('studentInfo').style.display = 'none';
                document.getElementById('anoLetivo').value = '';
                return;
            }

            // Verificar se já está matriculado
            const jaMatriculado = matriculas.some(matricula => matricula.alunoId === estudante.id);
            
            if (jaMatriculado) {
                showModal('Este estudante já possui uma matrícula ativa!');
                document.getElementById('cpfEstudante').value = '';
                document.getElementById('studentInfo').style.display = 'none';
                return;
            }
            
            // Mostrar informações do estudante
            document.getElementById('studentName').textContent = estudante.nome;
            document.getElementById('studentDetails').innerHTML = `
                <div><strong>CPF:</strong> ${estudante.cpf || 'N/A'}</div>
                <div><strong>Data Nascimento:</strong> ${estudante.dataNascimento || estudante.dataNasc || 'N/A'}</div>
                <div><strong>Idade:</strong> ${estudante.idade || 'N/A'} anos</div>
                <div><strong>Responsáveis:</strong> ${estudante.responsaveis ? estudante.responsaveis.join(', ') : 'N/A'}</div>
                <div><strong>Telefone:</strong> ${estudante.telefone || 'N/A'}</div>
                <div><strong>Endereço:</strong> ${estudante.endereco || 'N/A'}</div>
            `;
            document.getElementById('studentInfo').style.display = 'block';
            
            // Preencher dados automáticos
            document.getElementById('anoLetivo').value = new Date().getFullYear();
            document.getElementById('dataMatricula').value = new Date().toISOString().split('T')[0];
            } else if (cpf.length > 0) {
                document.getElementById('studentInfo').style.display = 'none';
                document.getElementById('anoLetivo').value = '';
            }
        }

        function preencherSelectTurmas() {
            const selects = [document.getElementById('turma'), document.getElementById('novaTurma')];
            
            selects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Selecione a turma</option>';
                    
                    if (turmas && turmas.length > 0) {
                        turmas.forEach(turma => {
                            const option = document.createElement('option');
                            option.value = turma.turma;
                            option.textContent = `${turma.turma} - Prof. ${turma.professor} (${turma.mensalidade})`;
                            select.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "Nenhuma turma cadastrada";
                        option.disabled = true;
                        select.appendChild(option);
                    }
                }
            });
        }

        function gerarNumeroMatricula() {
            const ano = new Date().getFullYear();
            const numero = Math.floor(Math.random() * 9999) + 1;
            return `${ano}${String(numero).padStart(4, '0')}`;
        }

        function listarMatriculas() {
            const container = document.getElementById('matriculasList');
            
            if (matriculas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-graduation-cap"></i>
                        <h3>Nenhuma matrícula encontrada</h3>
                        <p>Ainda não há estudantes matriculados</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = matriculas.map(matricula => {
                const estudante = estudantes.find(e => e.id === matricula.alunoId);
                const turmaInfo = turmas.find(t => t.turma === matricula.turma);
                return `
                    <div class="matricula-card">
                        <div class="matricula-header">
                            <div class="matricula-number">#${matricula.numeroMatricula}</div>
                            <div class="matricula-actions">
                                <button class="btn-action btn-edit" onclick="editarMatricula('${matricula.numeroMatricula}')" title="Editar matrícula">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-action btn-delete" onclick="excluirMatricula('${matricula.numeroMatricula}')" title="Excluir matrícula">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <strong>${estudante ? estudante.nome : 'Estudante não encontrado'}</strong><br>
                            <span style="color: #666;">Turma: ${matricula.turma}</span><br>
                            <span style="color: #666;">Professor: ${turmaInfo ? turmaInfo.professor : 'N/A'}</span><br>
                            <span style="color: #666;">Data: ${new Date(matricula.dataMatricula).toLocaleDateString('pt-BR')}</span><br>
                            <span class="status-badge status-ativa">Ativa</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-content`).classList.add('active');
            
            if (tab === 'rematricula') {
                listarMatriculas();
            }
        }

        function editarMatricula(numeroMatricula) {
            const matricula = matriculas.find(m => m.numeroMatricula === numeroMatricula);
            const estudante = estudantes.find(e => e.id === matricula.alunoId);
            
            if (matricula && estudante) {
                matriculaEditando = matricula;
                switchTab('rematricula');
                
                document.getElementById('estudanteRematricula').value = estudante.nome;
                document.getElementById('turmaAtual').value = matricula.turma;
                document.getElementById('numeroMatriculaRematricula').value = matricula.numeroMatricula;
                document.getElementById('dataRematricula').value = new Date().toISOString().split('T')[0];
                
                document.getElementById('rematriculaForm').style.display = 'block';
                document.getElementById('selectMatriculaMessage').style.display = 'none';
            }
        }

        function excluirMatricula(numeroMatricula) {
            if (confirm('Tem certeza que deseja excluir esta matrícula?')) {
                matriculas = matriculas.filter(m => m.numeroMatricula !== numeroMatricula);
                listarMatriculas();
                atualizarContadores();
                showModal('Matrícula excluída com sucesso!');
            }
        }

        function showModal(message) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        // Event Listeners
        document.getElementById('cpfEstudante').addEventListener('input', function(e) {
            // Formatação automática do CPF
            e.target.value = formatarCPF(e.target.value);
            
            // Busca automática quando CPF está completo
            buscarEstudantePorCPF();
        });

        document.getElementById('matriculaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const cpf = document.getElementById('cpfEstudante').value.replace(/\D/g, '');
            const turma = document.getElementById('turma').value;
            const dataMatricula = document.getElementById('dataMatricula').value;
            
            if (!cpf || !turma || !dataMatricula) {
                showModal('Por favor, preencha todos os campos obrigatórios!');
                return;
            }

            const estudante = estudantes.find(e => e.cpf && e.cpf.replace(/\D/g, '') === cpf);
            
            if (!estudante) {
                showModal('Estudante não encontrado!');
                return;
            }

            // Verificar se a turma tem vagas disponíveis
            const turmaInfo = turmas.find(t => t.turma === turma);
            if (!turmaInfo) {
                showModal('Turma não encontrada!');
                return;
            }
            
            const alunosMatriculados = matriculas.filter(m => m.turma === turma).length;
            
            if (alunosMatriculados >= parseInt(turmaInfo.quantidade)) {
                showModal('Esta turma não possui vagas disponíveis!');
                return;
            }

            const numeroMatricula = gerarNumeroMatricula();

            const novaMatricula = {
                numeroMatricula,
                alunoId: estudante.id,
                turma,
                dataMatricula,
                anoLetivo: new Date().getFullYear(),
                status: 'ativa'
            };

            matriculas.push(novaMatricula);
            
            showModal(`Matrícula realizada com sucesso!\nEstudante: ${estudante.nome}\nNúmero: ${numeroMatricula}`);
            document.getElementById('matriculaForm').reset();
            document.getElementById('studentInfo').style.display = 'none';
            listarMatriculas();
            atualizarContadores();
        });

        document.getElementById('rematriculaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const novaTurma = document.getElementById('novaTurma').value;
            const dataRematricula = document.getElementById('dataRematricula').value;
            
            if (!novaTurma || !dataRematricula) {
                showModal('Por favor, preencha todos os campos obrigatórios!');
                return;
            }

            if (novaTurma === matriculaEditando.turma) {
                showModal('Selecione uma turma diferente da atual!');
                return;
            }

            // Verificar vagas na nova turma
            const turmaInfo = turmas.find(t => t.turma === novaTurma);
            const alunosMatriculados = matriculas.filter(m => m.turma === novaTurma).length;
            
            if (alunosMatriculados >= parseInt(turmaInfo.quantidade)) {
                showModal('A nova turma não possui vagas disponíveis!');
                return;
            }

            // Atualizar matrícula
            const index = matriculas.findIndex(m => m.numeroMatricula === matriculaEditando.numeroMatricula);
            if (index !== -1) {
                matriculas[index].turma = novaTurma;
                matriculas[index].dataMatricula = dataRematricula;
                
                showModal(`Rematrícula realizada com sucesso!\nNova turma: ${novaTurma}`);
                document.getElementById('rematriculaForm').reset();
                document.getElementById('rematriculaForm').style.display = 'none';
                document.getElementById('selectMatriculaMessage').style.display = 'block';
                listarMatriculas();
                matriculaEditando = null;
            }
        });

        // Fechar modal ao clicar fora
        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Menu interativo
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.menu-item').forEach(i => {
                    i.classList.remove('active');
                });
                this.classList.add('active');
            });
        });

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            carregarDados();
            preencherSelectTurmas();
            listarMatriculas();
        });
    </script>
</body>
</html>